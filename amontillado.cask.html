<!DOCTYPE html>
<html><head><meta charset="UTF-8"><link href="css/default.css" rel="stylesheet" type="text/css"><script src="js/jquery.min.js" type="text/javascript"></script><script src="js/page_effects.js" type="text/javascript"></script><title>amontillado.cask documentation</title></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a></h2><h1><a href="index.html">Amontillado 0.1.0 API documentation</a></h1></div><div class="sidebar" id="namespaces"><h3><a href="index.html"><span class="inner">Namespaces</span></a></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>amontillado</span></div></div></li><li class="depth-2 current"><a href="amontillado.cask.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>cask</span></div></a></li></ul></div><div class="sidebar" id="vars"><h3><a href="#top"><span class="inner">Public Vars</span></a></h3><ul><li class="depth-1"><a href="amontillado.cask.html#var--.3EBitCask"><div class="inner"><span>-&gt;BitCask</span></div></a></li><li class="depth-1"><a href="amontillado.cask.html#var--.3ECaskFile"><div class="inner"><span>-&gt;CaskFile</span></div></a></li><li class="depth-1"><a href="amontillado.cask.html#var--.3ECaskFiles"><div class="inner"><span>-&gt;CaskFiles</span></div></a></li><li class="depth-1"><a href="amontillado.cask.html#var-allocate"><div class="inner"><span>allocate</span></div></a></li><li class="depth-1"><a href="amontillado.cask.html#var-cask-contains.3F"><div class="inner"><span>cask-contains?</span></div></a></li><li class="depth-1"><a href="amontillado.cask.html#var-cask-density"><div class="inner"><span>cask-density</span></div></a></li><li class="depth-1"><a href="amontillado.cask.html#var-cask-file"><div class="inner"><span>cask-file</span></div></a></li><li class="depth-1"><a href="amontillado.cask.html#var-cask-keys"><div class="inner"><span>cask-keys</span></div></a></li><li class="depth-1"><a href="amontillado.cask.html#var-check-current-file"><div class="inner"><span>check-current-file</span></div></a></li><li class="depth-1"><a href="amontillado.cask.html#var-crc"><div class="inner"><span>crc</span></div></a></li><li class="depth-1"><a href="amontillado.cask.html#var-current-file"><div class="inner"><span>current-file</span></div></a></li><li class="depth-1"><a href="amontillado.cask.html#var-dead-files"><div class="inner"><span>dead-files</span></div></a></li><li class="depth-1"><a href="amontillado.cask.html#var-delete-key"><div class="inner"><span>delete-key</span></div></a></li><li class="depth-1"><a href="amontillado.cask.html#var-entry-source"><div class="inner"><span>entry-source</span></div></a></li><li class="depth-1"><a href="amontillado.cask.html#var-file-record"><div class="inner"><span>file-record</span></div></a></li><li class="depth-1"><a href="amontillado.cask.html#var-file-record-no-crc"><div class="inner"><span>file-record-no-crc</span></div></a></li><li class="depth-1"><a href="amontillado.cask.html#var-file-tombstone-record"><div class="inner"><span>file-tombstone-record</span></div></a></li><li class="depth-1"><a href="amontillado.cask.html#var-generate-hint-file"><div class="inner"><span>generate-hint-file</span></div></a></li><li class="depth-1"><a href="amontillado.cask.html#var-hint-file-exists.3F"><div class="inner"><span>hint-file-exists?</span></div></a></li><li class="depth-1"><a href="amontillado.cask.html#var-hint-file-last-modified"><div class="inner"><span>hint-file-last-modified</span></div></a></li><li class="depth-1"><a href="amontillado.cask.html#var-id-to-file"><div class="inner"><span>id-to-file</span></div></a></li><li class="depth-1"><a href="amontillado.cask.html#var-key-dir-entry"><div class="inner"><span>key-dir-entry</span></div></a></li><li class="depth-1"><a href="amontillado.cask.html#var-load-hint-file"><div class="inner"><span>load-hint-file</span></div></a></li><li class="depth-1"><a href="amontillado.cask.html#var-map-.3ECaskFile"><div class="inner"><span>map-&gt;CaskFile</span></div></a></li><li class="depth-1"><a href="amontillado.cask.html#var-map-.3ECaskFiles"><div class="inner"><span>map-&gt;CaskFiles</span></div></a></li><li class="depth-1"><a href="amontillado.cask.html#var-new-bitcask"><div class="inner"><span>new-bitcask</span></div></a></li><li class="depth-1"><a href="amontillado.cask.html#var-new-cask-files"><div class="inner"><span>new-cask-files</span></div></a></li><li class="depth-1"><a href="amontillado.cask.html#var-open-bitcask"><div class="inner"><span>open-bitcask</span></div></a></li><li class="depth-1"><a href="amontillado.cask.html#var-read-key"><div class="inner"><span>read-key</span></div></a></li><li class="depth-1"><a href="amontillado.cask.html#var-read-key-as-bb"><div class="inner"><span>read-key-as-bb</span></div></a></li><li class="depth-1"><a href="amontillado.cask.html#var-renumber-files"><div class="inner"><span>renumber-files</span></div></a></li><li class="depth-1"><a href="amontillado.cask.html#var-rollover"><div class="inner"><span>rollover</span></div></a></li><li class="depth-1"><a href="amontillado.cask.html#var-validate-hint-file"><div class="inner"><span>validate-hint-file</span></div></a></li><li class="depth-1"><a href="amontillado.cask.html#var-write-key"><div class="inner"><span>write-key</span></div></a></li><li class="depth-1"><a href="amontillado.cask.html#var-write-to-cask"><div class="inner"><span>write-to-cask</span></div></a></li><li class="depth-1"><a href="amontillado.cask.html#var-write-tombstone-to-cask"><div class="inner"><span>write-tombstone-to-cask</span></div></a></li></ul></div><div class="namespace-docs" id="content"><h2 class="anchor" id="top">amontillado.cask</h2><div class="doc"><pre class="plaintext">Amontillado provides bitcask inspired storage for programs written
in Clojure. Bitcask is an append only log like file format for
storing key-value data made popular because it was/is available as a
storage backend for Riak. You can read Basho&apos;s description here
<a href="http://downloads.basho.com/papers/bitcask-intro.pdf">http://downloads.basho.com/papers/bitcask-intro.pdf</a>.

Amontillado persists data to disk, while keeping an index(map) in
memory to make data retrieval fast.

The main api entry points are open-bitcask, write-key, read-key, and
delete-key,</pre></div><div class="public anchor" id="var--.3EBitCask"><h3>-&gt;BitCask</h3><div class="usage"><code>(-&gt;BitCask dict files)</code></div><div class="doc"><pre class="plaintext">Positional factory function for class amontillado.cask.BitCask.
</pre></div></div><div class="public anchor" id="var--.3ECaskFile"><h3>-&gt;CaskFile</h3><div class="usage"><code>(-&gt;CaskFile id channel raf)</code></div><div class="doc"><pre class="plaintext">Positional factory function for class amontillado.cask.CaskFile.
</pre></div></div><div class="public anchor" id="var--.3ECaskFiles"><h3>-&gt;CaskFiles</h3><div class="usage"><code>(-&gt;CaskFiles files directory limit)</code></div><div class="doc"><pre class="plaintext">Positional factory function for class amontillado.cask.CaskFiles.
</pre></div></div><div class="public anchor" id="var-allocate"><h3>allocate</h3><div class="usage"><code>(allocate fc n)</code></div><div class="doc"><pre class="plaintext">given a file channel, lock on the channel them bump the channel&apos;s
position by n

used to pre-allocate space to write in files</pre></div></div><div class="public anchor" id="var-cask-contains.3F"><h3>cask-contains?</h3><div class="usage"><code>(cask-contains? bc key)</code></div><div class="doc"><pre class="plaintext">returns true if the given cask has had a value for the given key,
and that key was not removed after it was written.

This function does not require a disk seek/read like read-key does.</pre></div></div><div class="public anchor" id="var-cask-density"><h3>cask-density</h3><div class="usage"><code>(cask-density bc)</code></div><div class="doc"><pre class="plaintext">returns a map of file ids to live entry counts
</pre></div></div><div class="public anchor" id="var-cask-file"><h3>cask-file</h3><div class="usage"><code>(cask-file file-id directory)</code></div><div class="doc"><pre class="plaintext">given a file-id and a directory, returns a CaskFile with that id
</pre></div></div><div class="public anchor" id="var-cask-keys"><h3>cask-keys</h3><div class="usage"><code>(cask-keys bc)</code></div><div class="doc"><pre class="plaintext">return the keys of this bitcask
</pre></div></div><div class="public anchor" id="var-check-current-file"><h3>check-current-file</h3><div class="usage"><code>(check-current-file cf)</code></div><div class="doc"><pre class="plaintext">if the latest file is to large, push a new file
</pre></div></div><div class="public anchor" id="var-crc"><h3>crc</h3><div class="usage"><code>(crc bb)</code></div><div class="doc"><pre class="plaintext">calculate the crc of a byte buffer
</pre></div></div><div class="public anchor" id="var-current-file"><h3>current-file</h3><div class="usage"><code>(current-file cf)</code></div><div class="doc"><pre class="plaintext">given a CaskFiles returns the current file (the latest one)
</pre></div></div><div class="public anchor" id="var-dead-files"><h3>dead-files</h3><div class="usage"><code>(dead-files bc)</code></div><div class="doc"><pre class="plaintext">given a bitcask return a seq of files that are not referenced by the
in memory map</pre></div></div><div class="public anchor" id="var-delete-key"><h3>delete-key</h3><div class="usage"><code>(delete-key bc key)</code></div><div class="doc"><pre class="plaintext">removes the given key (byte array) from the in memory map and
writes a tombstone to disk</pre></div></div><div class="public anchor" id="var-entry-source"><h3>entry-source</h3><div class="usage"><code>(entry-source cask-file)</code></div><div class="doc"><pre class="plaintext"></pre></div></div><div class="public anchor" id="var-file-record"><h3>file-record</h3><div class="usage"><code>(file-record key value)</code></div><div class="doc"><pre class="plaintext">given a key (bytes) and value (bytes) generate a ByteBuffer for being written
 to a file. file-record format is:

crc -- crc of the rest of the record, calculated on the entire
record with the crc field as zeros, 8 bytes, a long

timestamp -- nanoseconds, long

key size -- byte count in key, long

value size -- byte count in value, long

key -- sized as in key size

value -- sized as in value size</pre></div></div><div class="public anchor" id="var-file-record-no-crc"><h3>file-record-no-crc</h3><div class="usage"><code>(file-record-no-crc ts k v)</code></div><div class="doc"><pre class="plaintext"></pre></div></div><div class="public anchor" id="var-file-tombstone-record"><h3>file-tombstone-record</h3><div class="usage"><code>(file-tombstone-record key)</code></div><div class="doc"><pre class="plaintext"></pre></div></div><div class="public anchor" id="var-generate-hint-file"><h3>generate-hint-file</h3><div class="usage"><code>(generate-hint-file bc)</code></div><div class="doc"><pre class="plaintext"></pre></div></div><div class="public anchor" id="var-hint-file-exists.3F"><h3>hint-file-exists?</h3><div class="usage"><code>(hint-file-exists? bc)</code></div><div class="doc"><pre class="plaintext"></pre></div></div><div class="public anchor" id="var-hint-file-last-modified"><h3>hint-file-last-modified</h3><div class="usage"><code>(hint-file-last-modified hint-file)</code></div><div class="doc"><pre class="plaintext"></pre></div></div><div class="public anchor" id="var-id-to-file"><h3>id-to-file</h3><div class="usage"><code>(id-to-file directory id)</code></div><div class="doc"><pre class="plaintext"></pre></div></div><div class="public anchor" id="var-key-dir-entry"><h3>key-dir-entry</h3><div class="usage"><code>(key-dir-entry file-id value-size value-position tstamp)</code></div><div class="doc"><pre class="plaintext">a key dir entry is what is kept in memory for each item a long with
the key, it has information for finding the value of a given key on
disk. it is an array of 4 longs</pre></div></div><div class="public anchor" id="var-load-hint-file"><h3>load-hint-file</h3><div class="usage"><code>(load-hint-file hint-file)</code></div><div class="doc"><pre class="plaintext"></pre></div></div><div class="public anchor" id="var-map-.3ECaskFile"><h3>map-&gt;CaskFile</h3><div class="usage"><code>(map-&gt;CaskFile m__5869__auto__)</code></div><div class="doc"><pre class="plaintext">Factory function for class amontillado.cask.CaskFile, taking a map of keywords to field values.
</pre></div></div><div class="public anchor" id="var-map-.3ECaskFiles"><h3>map-&gt;CaskFiles</h3><div class="usage"><code>(map-&gt;CaskFiles m__5869__auto__)</code></div><div class="doc"><pre class="plaintext">Factory function for class amontillado.cask.CaskFiles, taking a map of keywords to field values.
</pre></div></div><div class="public anchor" id="var-new-bitcask"><h3>new-bitcask</h3><div class="usage"><code>(new-bitcask directory &amp; [limit])</code></div><div class="doc"><pre class="plaintext">start a new bitcask with the given limit
</pre></div></div><div class="public anchor" id="var-new-cask-files"><h3>new-cask-files</h3><div class="usage"><code>(new-cask-files directory limit)</code></div><div class="doc"><pre class="plaintext"></pre></div></div><div class="public anchor" id="var-open-bitcask"><h3>open-bitcask</h3><div class="usage"><code>(open-bitcask directory &amp; [limit])</code></div><div class="doc"><pre class="plaintext">open a new or existing bitcask

takes the directory to write the cask files to, and a limit in bytes
to split the files at

when opening an already existing bitcask deletes all the dead files</pre></div></div><div class="public anchor" id="var-read-key"><h3>read-key</h3><div class="usage"><code>(read-key bc key)</code></div><div class="doc"><pre class="plaintext">read the byte (array) value for the given key, returns nil if it
cannot find a value</pre></div></div><div class="public anchor" id="var-read-key-as-bb"><h3>read-key-as-bb</h3><div class="usage"><code>(read-key-as-bb bc key)</code></div><div class="doc"><pre class="plaintext"></pre></div></div><div class="public anchor" id="var-renumber-files"><h3>renumber-files</h3><div class="usage"><code>(renumber-files directory files)</code></div><div class="doc"><pre class="plaintext">if dead, no longer needed, files are deleted, the existing files
will need to be renumbered, this function does that</pre></div></div><div class="public anchor" id="var-rollover"><h3>rollover</h3><div class="usage"><code>(rollover bc threshold)</code></div><div class="doc"><pre class="plaintext">finds files that contain less then threshold number live keys and
rolls them over in to new files, hopefully consolidating live files
so dead files can be deleted</pre></div></div><div class="public anchor" id="var-validate-hint-file"><h3>validate-hint-file</h3><div class="usage"><code>(validate-hint-file bc)</code></div><div class="doc"><pre class="plaintext"></pre></div></div><div class="public anchor" id="var-write-key"><h3>write-key</h3><div class="usage"><code>(write-key bc key value)</code></div><div class="doc"><pre class="plaintext">given a key, value, and bitcask, and an entry to the bitcask
mapping the key to the value</pre></div></div><div class="public anchor" id="var-write-to-cask"><h3>write-to-cask</h3><div class="usage"><code>(write-to-cask cask-file key value)</code></div><div class="doc"><pre class="plaintext">write a given key and value to a given file
</pre></div></div><div class="public anchor" id="var-write-tombstone-to-cask"><h3>write-tombstone-to-cask</h3><div class="usage"><code>(write-tombstone-to-cask cask-file key)</code></div><div class="doc"><pre class="plaintext">write a tombstone entry for a given key to a given file

a tombstone for a key is a marker that a given key has been
`deleted`</pre></div></div></div></body></html>